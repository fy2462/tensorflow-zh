# 使用GPUs <a class="md-anchor" id="AUTOGENERATED-using-gpus"></a>

## 支持的设备 <a class="md-anchor" id="AUTOGENERATED-supported-devices"></a>

在一套标准的系统上通常有多个计算设备.TensorFlow中支持CPU和GPU两种.我们用指定字符串
`strings`来标识这些设备.比如:

*  `"/cpu:0"`:机器的CPU
*  `"/gpu:0"`:机器的GPU,如果你有一个的话.
*  `"/gpu:1"`:机器的第二个GPU,以此类推...

如果一个TensorFlow系统中兼有CPU和GPU实现,当你指派设备时GPU有优先权.比如`matmul`中CPU
和GPU核心都有.那么在`cpu:0`和`gpu:0`中,`gpu:0`会被选择运行`matmul`.

## 记录使用设备的位置 <a class="md-anchor" id="AUTOGENERATED-logging-device-placement"></a>

为了获取你的operations和Tensor被指派到哪个设备上运行，用`log_device_placement`新建一个`session`,并设置为`True`.

```python
# 新建一个graph.
a = tf.constant([1.0, 2.0, 3.0, 4.0, 5.0, 6.0], shape=[2, 3], name='a')
b = tf.constant([1.0, 2.0, 3.0, 4.0, 5.0, 6.0], shape=[3, 2], name='b')
c = tf.matmul(a, b)
# 新建session with log_device_placement并设置为True.
sess = tf.Session(config=tf.ConfigProto(log_device_placement=True))
# 运行这个op.
print sess.run(c)
```

你应该能看见以下输出:

```
Device mapping:
/job:localhost/replica:0/task:0/gpu:0 -> device: 0, name: Tesla K40c, pci bus
id: 0000:05:00.0
b: /job:localhost/replica:0/task:0/gpu:0
a: /job:localhost/replica:0/task:0/gpu:0
MatMul: /job:localhost/replica:0/task:0/gpu:0
[[ 22.  28.]
 [ 49.  64.]]

```

## 手工指定使用的设备 <a class="md-anchor" id="AUTOGENERATED-manual-device-placement"></a>

如果你想让指定设备运行operation而不用系统自动为你分配的，你可以用`with tf.device`
创建一个设备环境，这个环境下的操作都统一运行在环境指定的设备上.

```python
# 新建一个graph.
with tf.device('/cpu:0'):
  a = tf.constant([1.0, 2.0, 3.0, 4.0, 5.0, 6.0], shape=[2, 3], name='a')
  b = tf.constant([1.0, 2.0, 3.0, 4.0, 5.0, 6.0], shape=[3, 2], name='b')
c = tf.matmul(a, b)
# 新建session with log_device_placement并设置为True.
sess = tf.Session(config=tf.ConfigProto(log_device_placement=True))
# 运行这个op.
print sess.run(c)
```

你会发现现在`a`和`b`操作都被分配给了`cpu:0`.

```
Device mapping:
/job:localhost/replica:0/task:0/gpu:0 -> device: 0, name: Tesla K40c, pci bus
id: 0000:05:00.0
b: /job:localhost/replica:0/task:0/cpu:0
a: /job:localhost/replica:0/task:0/cpu:0
MatMul: /job:localhost/replica:0/task:0/gpu:0
[[ 22.  28.]
 [ 49.  64.]]
```

## 在多GPU系统里使用单一GPU<a class="md-anchor" id="AUTOGENERATED-using-a-single-gpu-on-a-multi-gpu-system"></a>

如果你的系统里有多个GPU，ID最小的GPU会被默认选中.如果你想用别的GPU，
可以这样指明你的偏好：

```python
# 新建一个graph.
with tf.device('/gpu:2'):
  a = tf.constant([1.0, 2.0, 3.0, 4.0, 5.0, 6.0], shape=[2, 3], name='a')
  b = tf.constant([1.0, 2.0, 3.0, 4.0, 5.0, 6.0], shape=[3, 2], name='b')
  c = tf.matmul(a, b)
# 新建session with log_device_placement并设置为True.
sess = tf.Session(config=tf.ConfigProto(log_device_placement=True))
# 运行这个op.
print sess.run(c)
```

如果你指定的设备不存在，你会收到`InvalidArgumentError`提示：

```
InvalidArgumentError: Invalid argument: Cannot assign a device to node 'b':
Could not satisfy explicit device specification '/gpu:2'
   [[Node: b = Const[dtype=DT_FLOAT, value=Tensor<type: float shape: [3,2]
   values: 1 2 3...>, _device="/gpu:2"]()]]
```

如果你希望TensorFlow自动选择一个存在的且被支持的设备以防你指定的设备不存在，
你可以在创建的`session`里把参数`allow_soft_placement`设置为`True`

```python
# 新建一个graph.
with tf.device('/gpu:2'):
  a = tf.constant([1.0, 2.0, 3.0, 4.0, 5.0, 6.0], shape=[2, 3], name='a')
  b = tf.constant([1.0, 2.0, 3.0, 4.0, 5.0, 6.0], shape=[3, 2], name='b')
  c = tf.matmul(a, b)
# 新建session with log_device_placement并设置为True.
sess = tf.Session(config=tf.ConfigProto(
      allow_soft_placement=True, log_device_placement=True))
# 运行这个op.
print sess.run(c)
```

## 使用多个GPU <a class="md-anchor" id="AUTOGENERATED-using-multiple-gpus"></a>

如果你想让TensorFlow在多个GPU上运行，你可以建立multi-tower结构，在这个结构
里每个tower分别被指配给不同的GPU运行.比如：

```
# 新建一个graph.
c = []
for d in ['/gpu:2', '/gpu:3']:
  with tf.device(d):
    a = tf.constant([1.0, 2.0, 3.0, 4.0, 5.0, 6.0], shape=[2, 3])
    b = tf.constant([1.0, 2.0, 3.0, 4.0, 5.0, 6.0], shape=[3, 2])
    c.append(tf.matmul(a, b))
with tf.device('/cpu:0'):
  sum = tf.add_n(c)
# 新建session with log_device_placement并设置为True.
sess = tf.Session(config=tf.ConfigProto(log_device_placement=True))
# 运行这个op.
print sess.run(sum)
```

你会看到如下输出：

```
Device mapping:
/job:localhost/replica:0/task:0/gpu:0 -> device: 0, name: Tesla K20m, pci bus
id: 0000:02:00.0
/job:localhost/replica:0/task:0/gpu:1 -> device: 1, name: Tesla K20m, pci bus
id: 0000:03:00.0
/job:localhost/replica:0/task:0/gpu:2 -> device: 2, name: Tesla K20m, pci bus
id: 0000:83:00.0
/job:localhost/replica:0/task:0/gpu:3 -> device: 3, name: Tesla K20m, pci bus
id: 0000:84:00.0
Const_3: /job:localhost/replica:0/task:0/gpu:3
Const_2: /job:localhost/replica:0/task:0/gpu:3
MatMul_1: /job:localhost/replica:0/task:0/gpu:3
Const_1: /job:localhost/replica:0/task:0/gpu:2
Const: /job:localhost/replica:0/task:0/gpu:2
MatMul: /job:localhost/replica:0/task:0/gpu:2
AddN: /job:localhost/replica:0/task:0/cpu:0
[[  44.   56.]
 [  98.  128.]]
```

[cifar10 tutorial](../../tutorials/deep_cnn/index.md) 这个例子很好的演示了怎样用GPU集群训练.

> 原文:[using_gpu](http://tensorflow.org/how_tos/using_gpu/index.md)
翻译:[@lianghyv](https://github.com/lianghyv) 校对:[](https://github.com/)
